<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë„ì‹œë³„ ë‚ ì”¨ ì˜ˆì¸¡</title>
  <style>
    body { font-family: 'Inter', sans-serif; padding: 20px; background-color: #f4f7f6; color: #333; }
    .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
    .input-section { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
    #cityInput { padding: 12px 18px; border: 1px solid #ddd; border-radius: 8px; flex-grow: 1; max-width: 300px; font-size: 16px; }
    button {
      padding: 12px 25px;
      background: linear-gradient(145deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    button:hover {
      background: linear-gradient(145deg, #45a049, #4CAF50);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    /* 'í˜„ì¬ ìœ„ì¹˜' ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .location-button {
      background: #3498db; /* íŒŒë€ìƒ‰ ê³„ì—´ */
      width: 100%; /* ë„ˆë¹„ë¥¼ ê½‰ ì±„ì›€ */
      max-width: 400px; /* ìµœëŒ€ ë„ˆë¹„ (ê¸°ì¡´ input+buttonê³¼ ë¹„ìŠ·í•˜ê²Œ) */
      margin-bottom: -15px; /* ì•„ë˜ input-sectionê³¼ì˜ ê°„ê²© ì¡°ì ˆ */
    }
    .location-button:hover {
      background: #2980b9;
    }
    
    table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
    th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: center; }
    th { background-color: #f0f8ff; color: #34495e; font-weight: 600; text-transform: uppercase; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #eef; }
    td strong { color: #28a745; font-weight: bold; }
    .chart-container { 
      margin-top: 40px; 
      padding: 20px; 
      background-color: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      height: 50vh; 
      max-height: 400px;
    }
    .message-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      text-align: center;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      max-width: 80%;
    }
    .message-box h3 { margin: 0; color: #e74c3c; }
    .message-box p { margin: 10px 0 0; color: #555; }
    .message-box button {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    .message-box button:hover { background-color: #2980b9; }

    .tooltip-img {
      position: fixed;
      display: none;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      z-index: 2000;
      width: 360px;
      text-align: center;
    }
    .tooltip-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
      color: #6b7280;
    }
    .tooltip-title {
      font-weight: 700;
      color: #111827;
      font-size: 16px;
    }
    .tooltip-img .outfit-description {
      margin-top: 15px;
      font-size: 1.1em;
      color: #374151;
      line-height: 1.6;
      text-align: left;
      white-space: pre-wrap;
    }
    .tooltip-img button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      width: 100%;
      transition: background-color 0.2s ease;
    }
    .tooltip-img button:hover {
      background-color: #2980b9;
    }

    @media (max-width: 768px) {
      .input-section { flex-direction: column; align-items: center; }
      #cityInput { max-width: 100%; }
      button { width: 100%; }
      table, th, td { font-size: 0.9em; }
      .container { padding: 15px; margin: 10px; }
      .tooltip-img { width: 90%; max-width: 360px; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2>ë‚ ì”¨ ì˜ˆë³´</h2>
    
    <div class="input-section">
      <button onclick="getLocation()" class="location-button">ğŸ“ í˜„ì¬ ìœ„ì¹˜ë¡œ ë‚ ì”¨ í™•ì¸</button>
    </div>

    <div class="input-section">
      <input type="text" id="cityInput" placeholder="ë„ì‹œëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: Seoul)" />
      <button onclick="getWeather()">ë‚ ì”¨ í™•ì¸</button>
    </div>
    
    <table id="resultTable">
      <thead>
        <tr>
          <th>ë‚ ì§œ</th>
          <th>ì‹œê°„</th>
          <th>OpenWeather</th>
          <th>WeatherAPI</th>
          <th>Tomorrow.io</th>
          <th>ì˜ˆì¸¡ ê²°ê³¼</th>
          <th>í‰ê· ê¸°ì˜¨</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>

    <div id="chartContainer" class="chart-container">
      <canvas id="tempChart"></canvas>
    </div>
  </div>

  <div id="messageBox" class="message-box">
    <h3 id="messageTitle"></h3>
    <p id="messageContent"></p>
    <button onclick="hideMessageBox()">í™•ì¸</button>
  </div>

  <div id="clothingPopup" class="tooltip-img" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===== ì˜·ì°¨ë¦¼ íŒì—… ê´€ë ¨ (ìˆ˜ì •ë¨) =====
const popup = document.getElementById("clothingPopup");

/** ì˜·ì°¨ë¦¼ íŒì—… ì—´ê¸° (condition ì¸ì ì¶”ê°€ë¨) */
async function showClothingPopup(temp, condition) { // <-- 1. condition ì¸ì ë°›ê¸°
  const popup = document.getElementById("clothingPopup");
  
  // í˜„ì¬ ì…ë ¥ëœ ìœ„ì¹˜(ë„ì‹œëª… ë˜ëŠ” ì¢Œí‘œ) ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
  const location = document.getElementById("cityInput").value || "íŠ¹ì • ì¥ì†Œ ì—†ìŒ";

  popup.innerHTML = `
    <div class="tooltip-header">
      <div class="tooltip-title">âœ¨ ì¶”ì²œ ì˜·ì°¨ë¦¼</div>
      <div aria-hidden="true">${Number(temp).toFixed(1)}Â°C (${condition})</div>
    </div>
    <div class="outfit-description">AIê°€ "${location}"ì˜ "${condition}" ë‚ ì”¨ì— ë§ì¶°<br>ì˜·ì°¨ë¦¼ì„ ìƒì„±í•˜ëŠ” ì¤‘...</div>
    <button onclick="hideClothingPopup()">ë‹«ê¸°</button>
  `;
  popup.style.display = "block";

  try {
    // 2. 'condition' íŒŒë¼ë¯¸í„°ë¥¼ fetch ì£¼ì†Œì— ì¶”ê°€
    const response = await fetch(`/api/generate-outfit?temp=${temp}&location=${encodeURIComponent(location)}&condition=${encodeURIComponent(condition)}`);
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'ì„œë²„ì—ì„œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
    
    const data = await response.json();
    const outfitDescription = data.outfit;

    // AIê°€ ìƒì„±í•œ ë‹µë³€ìœ¼ë¡œ íŒì—… ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    popup.innerHTML = `
      <div class="tooltip-header">
        <div class="tooltip-title">âœ¨ ì¶”ì²œ ì˜·ì°¨ë¦¼</div>
        <div aria-hidden="true">${Number(temp).toFixed(1)}Â°C (${condition})</div>
      </div>
      <div class="outfit-description" style="white-space: pre-wrap;">${outfitDescription}</div>
      <button onclick="hideClothingPopup()">í™•ì¸</button>
    `;

  } catch (error) {
    console.error("ì˜·ì°¨ë¦¼ ì¶”ì²œ ì˜¤ë¥˜:", error);
    popup.innerHTML = `
      <div class="tooltip-header">
        <div class="tooltip-title">ì˜¤ë¥˜ ë°œìƒ</div>
      </div>
      <div class="outfit-description">${error.message}</div>
      <button onclick="hideClothingPopup()">ë‹«ê¸°</button>
    `;
  }
}

/** ì˜·ì°¨ë¦¼ íŒì—… ë‹«ê¸° */
function hideClothingPopup() {
  popup.style.display = "none";
}

// ===== ë©”ì‹œì§€ ë°•ìŠ¤ =====
function showMessageBox(title, message) {
  document.getElementById('messageTitle').innerText = title;
  document.getElementById('messageContent').innerText = message;
  document.getElementById('messageBox').style.display = 'flex';
}
function hideMessageBox() {
  document.getElementById('messageBox').style.display = 'none';
}

// ===== GPS ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ë„ì‹œ ì´ë¦„ ë³€í™˜ ê¸°ëŠ¥ ì¶”ê°€ë¨) =====
function getLocation() {
  if (navigator.geolocation) {
    showMessageBox("ìœ„ì¹˜ í™•ì¸ ì¤‘...", "ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ì •ë³´ í—ˆìš© íŒì—…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    
    navigator.geolocation.getCurrentPosition(
      // (A) ì„±ê³µ ì‹œ
      async (position) => {
        const lat = position.coords.latitude;  // ìœ„ë„
        const lon = position.coords.longitude; // ê²½ë„
        
        try {
          // (1) OpenWeather ë¦¬ë²„ìŠ¤ ì§€ì˜¤ì½”ë”© API í˜¸ì¶œ
          const openWeatherKey = "5045da01a15a2d73d9763f79a7424d47"; // ê¸°ì¡´ í‚¤ ì¬ì‚¬ìš©
          const geocodingURL = `https://corsproxy.io/?https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${openWeatherKey}`;
          
          const res = await fetch(geocodingURL);
          const json = await res.json();
          
          if (!json || json.length === 0 || !json[0].name) {
            throw new Error("ë„ì‹œ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
          
          const cityName = json[0].name; // APIê°€ ë°˜í™˜í•œ ë„ì‹œ ì´ë¦„ (ì˜ˆ: "Iksan-si")
          
          // (2) ê°€ì ¸ì˜¨ ë„ì‹œ ì´ë¦„ì„ ë„ì‹œ ì…ë ¥ì°½ì— ë„£ì–´ì¤ë‹ˆë‹¤.
          document.getElementById("cityInput").value = cityName;
          
          // (3) ê¸°ì¡´ getWeather í•¨ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
          showMessageBox("ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ", `${cityName}ì˜ ë‚ ì”¨ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.`);
          getWeather();
          
        } catch (err) {
          // ë¦¬ë²„ìŠ¤ ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨ ì‹œ (ì¢Œí‘œë¡œë¼ë„ ê²€ìƒ‰ ì‹œë„)
          console.error("ë¦¬ë²„ìŠ¤ ì§€ì˜¤ì½”ë”© ì˜¤ë¥˜:", err.message);
          showMessageBox("ë„ì‹œ ì´ë¦„ ë³€í™˜ ì‹¤íŒ¨", "ì¢Œí‘œë¡œ ë‚ ì”¨ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.");
          document.getElementById("cityInput").value = `${lat},${lon}`; // ì›ë˜ëŒ€ë¡œ ì¢Œí‘œ ì…ë ¥
          getWeather();
        }
      },
      // (B) GPS ì‹¤íŒ¨ (ê±°ë¶€) ì‹œ
      (error) => {
        console.error("GPS Error:", error.message);
        showMessageBox("ìœ„ì¹˜ ì˜¤ë¥˜", "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
      }
    );
  } else {
    // Geolocation APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì˜¤ë˜ëœ ë¸Œë¼ìš°ì €
    showMessageBox("ì§€ì› ì•ˆ í•¨", "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
}

// ===== ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (GPS ì¢Œí‘œ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •ë¨) =====
async function getWeather() {
  const city = document.getElementById("cityInput").value;
  if (!city) {
    showMessageBox("ì…ë ¥ ì˜¤ë¥˜", "ë„ì‹œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  const openWeatherKey = "5045da01a15a2d73d9763f79a7424d47";
  const weatherAPIKey = "5517be1ed59948f99c772834250106";
  const tomorrowKey = "rnMUfqE2BlmgdUW4gLKVgsvbobn4NnkF";

  let openData = {}, weatherAPIData = {}, tomorrowData = {};
  let lat = null;
  let lon = null;

  // (1) ì¢Œí‘œ/ë„ì‹œì´ë¦„ ê°ì§€ ë¡œì§
  let isCoord = false;
  const coords = city.split(',');
  if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
    isCoord = true;
    lat = parseFloat(coords[0]);
    lon = parseFloat(coords[1]);
  }

  // (2) OpenWeather URL ìƒì„± ë°©ì‹ ìˆ˜ì •
  let openURL = '';
  if (isCoord) {
    openURL = `https://corsproxy.io/?https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${openWeatherKey}&units=metric`;
  } else {
    openURL = `https://corsproxy.io/?https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${openWeatherKey}&units=metric`;
  }

  // WeatherAPI URL (q= íŒŒë¼ë¯¸í„°ê°€ ì¢Œí‘œë„ ì§€ì›í•˜ë¯€ë¡œ ìˆ˜ì • ë¶ˆí•„ìš”)
  const weatherAPIURL = `https://corsproxy.io/?http://api.weatherapi.com/v1/forecast.json?key=${weatherAPIKey}&q=${city}&days=4&aqi=no&alerts=no`;

  try {
    const res = await fetch(openURL);
    const json = await res.json();
    if (json.cod !== "200") throw new Error(json.message || "OpenWeather API error");
    
    json.list.forEach(item => {
      const dtUTC = new Date(item.dt_txt.replace(" ", "T") + "Z");
      const dtKST = new Date(dtUTC.getTime() + (9 * 60 * 60 * 1000));
      const date = dtKST.toISOString().slice(0, 10);
      const time = dtKST.toISOString().slice(11, 16);
      const hour = parseInt(time.substring(0, 2));
      if (hour % 3 === 0) {
        if (!openData[date]) openData[date] = {};
        openData[date][time] = { weather: item.weather[0].main, temp: item.main.temp };
      }
    });

    // (3) lat, lon ê°’ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ ìˆ˜ì •
    if (!isCoord) {
        lat = json.city.coord.lat;
        lon = json.city.coord.lon;
    }
  } catch (err) {
    console.error("OpenWeather ë°ì´í„° ì˜¤ë¥˜:", err);
    showMessageBox("API ì˜¤ë¥˜", "OpenWeather ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }

  try {
    const res = await fetch(weatherAPIURL);
    const json = await res.json();
    if (json.error) throw new Error(json.error.message || "WeatherAPI error");
    json.forecast.forecastday.forEach(day => {
      const date = day.date;
      day.hour.forEach(hour => {
        const h = hour.time.split(" ")[1].substring(0, 2);
        if (parseInt(h) % 3 === 0) {
          const time = hour.time.split(" ")[1].substring(0, 5);
          if (!weatherAPIData[date]) weatherAPIData[date] = {};
          weatherAPIData[date][time] = { weather: hour.condition.text, temp: hour.temp_c };
        }
      });
    });
  } catch (err) {
    console.error("WeatherAPI ë°ì´í„° ì˜¤ë¥˜:", err);
  }

  try {
    // (4) Tomorrow.io ë¡œì§ (ì´ì œ lat, lonì´ ìœ„ì—ì„œ ì¤€ë¹„ë¨)
    if (!lat || !lon) {
        console.warn("ìœ„ì¹˜ ì¢Œí‘œ ì—†ìŒ (Tomorrow.io ìš”ì²­ ê±´ë„ˆëœ€)");
    } else {
        const tomorrowURL = `https://corsproxy.io/?https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1h&apikey=${tomorrowKey}`;
        const res = await fetch(tomorrowURL);
        const json = await res.json();
        if (!json.timelines || !json.timelines.hourly) throw new Error("hourly ë°ì´í„° ì—†ìŒ");
        const targetHours = [0, 3, 6, 9, 12, 15, 18, 21];
        json.timelines.hourly.forEach(item => {
          const dtUTC = new Date(item.time);
          const dtKST = new Date(dtUTC.getTime() + 9 * 60 * 60 * 1000);
          const hour = dtKST.getUTCHours();
          if (!targetHours.includes(hour)) return;
          if (!item.values || item.values.weatherCode === undefined || item.values.temperature === undefined) return;
          const date = dtKST.toISOString().split("T")[0];
          const time = dtKST.toISOString().substring(11, 16);
          const todayKSTForCompare = new Date();
          todayKSTForCompare.setHours(0,0,0,0);
          const itemDateKST = new Date(dtKST);
          itemDateKST.setHours(0,0,0,0);
          const dayDiff = Math.floor((itemDateKST - todayKSTForCompare) / (1000 * 60 * 60 * 24));
          if (dayDiff < 0 || dayDiff >= 5) return;
          if (!tomorrowData[date]) tomorrowData[date] = {};
          const code = item.values.weatherCode;
          let weather = "Unknown";
          if ([1000, 1100].includes(code)) weather = "Sunny";
          else if (code === 1001) weather = "Cloudy";
          else if (code === 1001) weather = "Partly Cloudy";
          else if (code === 1102) weather = "Mostly Cloudy";
          else if (code >= 4000 && code < 5000) weather = "Rain";
          else if (code >= 5000 && code < 6000) weather = "Snow";
          else if (code >= 8000) weather = "Thunderstorm";
          tomorrowData[date][time] = { weather, temp: item.values.temperature };
        });
    }
  } catch (err) {
    console.error("Tomorrow.io ì˜¤ë¥˜:", err);
  }

  // --- (í…Œì´ë¸” ìƒì„± ë¡œì§) ---
  const todayForReference = new Date();
  const tomorrow = new Date(todayForReference); tomorrow.setDate(todayForReference.getDate() + 1);
  const dayAfterTomorrow = new Date(todayForReference); dayAfterTomorrow.setDate(todayForReference.getDate() + 2);
  const tomorrowDisplayStr = tomorrow.toISOString().split('T')[0];
  const dayAfterTomorrowDisplayStr = dayAfterTomorrow.toISOString().split('T')[0];

  const tbody = document.getElementById("resultsBody");
  tbody.innerHTML = "";

  const datesForTableDisplay = Array.from(new Set([
    ...Object.keys(openData),
    ...Object.keys(weatherAPIData),
    ...Object.keys(tomorrowData)
  ]))
  .filter(date => date === tomorrowDisplayStr || date === dayAfterTomorrowDisplayStr)
  .sort();

  if (datesForTableDisplay.length === 0) {
    showMessageBox("ì •ë³´ ì—†ìŒ", "ì„ íƒëœ ë‚ ì§œì— ëŒ€í•œ ì˜ˆë³´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
  }

  datesForTableDisplay.forEach(date => {
    const times = new Set([
      ...(openData[date] ? Object.keys(openData[date]) : []),
      ...(weatherAPIData[date] ? Object.keys(weatherAPIData[date]) : []),
      ...(tomorrowData[date] ? Object.keys(tomorrowData[date]) : []),
    ]);

    [...times].sort().forEach(time => {
      const hour = parseInt(time.split(":")[0]);
      if (hour % 3 !== 0) return;
      const openVal = openData[date]?.[time] || { weather: "N/A", temp: "-" };
      const weatherapiVal = weatherAPIData[date]?.[time] || { weather: "N/A", temp: "-" };
      const tomoVal = tomorrowData[date]?.[time] || { weather: "N/A", temp: "-" };
      const temps = [openVal.temp, weatherapiVal.temp, tomoVal.temp].filter(t => typeof t === "number");
      const avgTemp = temps.length > 0 ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) : "-";
      const votes = [openVal.weather, weatherapiVal.weather, tomoVal.weather]
        .filter(w => w !== "N/A" && w !== "ì˜¤ë¥˜" && w !== "Unknown");
      let majority = "N/A";
      if (votes.length > 0) {
        const freq = {};
        votes.forEach(w => freq[w] = (freq[w] || 0) + 1);
        majority = Object.entries(freq).sort((a, b) => b[1] - a[1])[0][0];
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td>${time}</td>
        <td>${openVal.weather} (${openVal.temp}Â°C)</td>
        <td>${weatherapiVal.weather} (${weatherapiVal.temp}Â°C)</td>
        <td>${tomoVal.weather} (${tomoVal.temp}Â°C)</td>
        <td><strong>${majority}</strong></td>
      `;
      tbody.appendChild(tr);

      const td = document.createElement("td");
      td.innerText = avgTemp + "Â°C";
      if (avgTemp !== "-") {
        td.style.cursor = "pointer";
        // ===== (ìˆ˜ì •ë¨) showClothingPopupì— majority ë³€ìˆ˜ ì „ë‹¬ =====
        td.addEventListener("click", () => showClothingPopup(Number(avgTemp), majority));
      }
      tr.appendChild(td);
    });
  });

  // --- (ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ ë¡œì§ - ì˜¤íƒ€ ìˆ˜ì •ë¨) ---
  const chartOpenData = {};
  const chartWeatherAPIData = {}; 
  const chartTomorrowData = {};
  if (openData[tomorrowDisplayStr]) chartOpenData[tomorrowDisplayStr] = openData[tomorrowDisplayStr];
  if (openData[dayAfterTomorrowDisplayStr]) chartOpenData[dayAfterTomorrowDisplayStr] = openData[dayAfterTomorrowDisplayStr];
  if (weatherAPIData[tomorrowDisplayStr]) chartWeatherAPIData[tomorrowDisplayStr] = weatherAPIData[tomorrowDisplayStr]; 
  if (weatherAPIData[dayAfterTomorrowDisplayStr]) chartWeatherAPIData[dayAfterTomorrowDisplayStr] = weatherAPIData[dayAfterTomorrowDisplayStr]; 
  if (tomorrowData[tomorrowDisplayStr]) chartTomorrowData[tomorrowDisplayStr] = tomorrowData[tomorrowDisplayStr];
  if (tomorrowData[dayAfterTomorrowDisplayStr]) chartTomorrowData[dayAfterTomorrowDisplayStr] = tomorrowData[dayAfterTomorrowDisplayStr];

  drawChart(chartOpenData, chartWeatherAPIData, chartTomorrowData); 
}

// --- (ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ - ì˜¤íƒ€ ìˆ˜ì •ë¨) ---
function drawChart(openData, weatherAPIData, tomorrowData) {
  const container = document.getElementById("chartContainer");
  container.innerHTML = `<canvas id="tempChart"></canvas>`;
  const ctx = document.getElementById("tempChart").getContext("2d");

  const isMobile = window.innerWidth <= 768;

  const labels = [];
  const openTemps = [];
  const weatherapiTemps = [];
  const tomorrowTemps = [];

  const allDates = new Set([
    ...Object.keys(openData),
    ...Object.keys(weatherAPIData),
    ...Object.keys(tomorrowData)
  ]);

  Array.from(allDates).sort().forEach(date => {
    const allTimes = new Set([
      ...(openData[date] ? Object.keys(openData[date]) : []),
      ...(weatherAPIData[date] ? Object.keys(weatherAPIData[date]) : []),
      ...(tomorrowData[date] ? Object.keys(tomorrowData[date]) : [])
    ]);

    Array.from(allTimes).sort().forEach(time => {
      const hour = parseInt(time.split(':')[0]);
      if (isMobile && hour % 6 !== 0) {
        return;
      }
      const label = `${date} ${time}`;
      labels.push(label);
      const openVal = openData[date]?.[time];
      openTemps.push(openVal ? openVal.temp : null);
      const weatherapiVal = weatherAPIData[date]?.[time];
      weatherapiTemps.push(weatherapiVal ? weatherapiVal.temp : null);
      const tomorrowVal = tomorrowData[date]?.[time];
      tomorrowTemps.push(tomorrowVal ? tomorrowVal.temp : null);
    });
  });

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'OpenWeather (Â°C)', data: openTemps, borderColor: 'blue', borderWidth: 2, fill: false, spanGaps: true }, 
        { label: 'WeatherAPI (Â°C)', data: weatherapiTemps, borderColor: 'green', borderWidth: 2, fill: false, spanGaps: true },
        { label: 'Tomorrow.io (Â°C)', data: tomorrowTemps, borderColor: 'orange', borderWidth: 2, fill: false, spanGaps: true }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { display: true }, y: { beginAtZero: false } }
    }
  });
}
</script>
</body>
</html>